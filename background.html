<html>
<script src="jquery.js"></script>
<script src="cache.js"></script>
<script src="underscore.js"></script>
<script src="wandermind.js"></script>

<script>
/* blocking */

var colors = {"work": [192, 0, 0, 255], "break": [0, 192, 0, 255]}
var finishedSound = new Audio("ring.mp3");

var interval

/* Modes: pause, work, break */

function change(request) {
    if (request.mode == "pause") {
        clearInterval(interval) // just in case
        chrome.browserAction.setBadgeText({text: ''})
        chrome.browserAction.setIcon({path: "icons/pause.png"})
        chrome.browserAction.setPopup({popup: "popup.html"})
    } else {
        var timeRemaining = request.duration * 60

        chrome.browserAction.setBadgeBackgroundColor({color: colors[request.mode]})
        chrome.browserAction.setBadgeText({text: formatDuration(timeRemaining)})
        chrome.browserAction.setIcon({path: "icons/" + request.mode + ".png"})
        chrome.browserAction.setPopup({popup: "popup_cancel.html"})

        function tick() {
            timeRemaining--
            
            chrome.browserAction.setBadgeText({text: formatDuration(timeRemaining)})

            if (timeRemaining <= 0) {
                notification = webkitNotifications.createNotification(
                    "icons/" + request.mode + ".png",
                    "Time's up!",
                    "Bring more work on!"
                )
                notification.show()
                finishedSound.play()

                cachetags = cache.getItem("tags", {})
                _.each(tags, function (tag) {
                    if (!tag) 
                        cachetags[tag] = 0
                    else
                        cachetags[tag] += 1
                })
                cache.setItem("tags", cachetags)

                mode.pause()
            }
        }

        interval = window.setInterval(tick, 1000)
        return interval
    }
}

mode.listen(change)

</script>
</html>

